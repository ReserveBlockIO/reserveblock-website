<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RBX Metamask Transaction</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  </head>
  <body>
    <div id="error" class="p-5" style="display: none">
      <p>MetaMask isn't installed in your browser.</p>
      <a href="https://reserveblock.io/" class="btn btn-dark">Go Back</a>
      <a href="https://metamask.io/" target="_blank" class="btn btn-light"
        >Install Metamask</a
      >
    </div>

    <div id="error2" class="p-5" style="display: none">
      <p>A problem occurred. Invalid page request</p>
    </div>

    <div id="container" class="p-5" style="display: none">
      <button onClick="request()" class="btn btn-dark">
        Begin Transaction
      </button>

      <h6 id="account" class="mt-2"></h6>
    </div>

    <script>
      var getParamAmount;
      var getParamAddress;

      var errorDiv = document.getElementById("error");
      var error2Div = document.getElementById("error2");
      var containerDiv = document.getElementById("container");
      var accountDiv = document.getElementById("account");

      window.onload = function () {
        init();
      };

      function init() {
        getParamAddress = _findGetParameter("address");
        getParamAmount = _findGetParameter("amount");

        if (getParamAddress == null || getParamAmount == null) {
          error2Div.style.display = "block";
          return;
        }

        if (typeof window.ethereum !== "undefined") {
          containerDiv.style.display = "block";
        } else {
          errorDiv.style.display = "block";
        }
      }

      function request() {
        ethereum.request({ method: "eth_requestAccounts" });

        getAccount();
      }

      function getAccount() {
        const accounts = ethereum
          .request({ method: "eth_requestAccounts" })
          .then(function (accounts) {
            const account = accounts[0];
            accountDiv.innerHTML = "Account: " + account;

            initTransaction(account);
          });
      }

      function initTransaction(account) {
        let web3 = new Web3(Web3.givenProvider);

        const to = getParamAddress;
        const v = getParamAmount;

        const valueWei = web3.utils.toWei(v, "ether");
        const valueHex = web3.utils.toHex(valueWei);

        const params = [
          {
            from: account,
            to: to,
            gas: "0x76c0",
            gasPrice: "0x9184e72a000",
            value: valueHex,
            data: "0xd46e8dd67c5d32be8d46e8dd67c5d32be8058bb8eb970870f072445675058bb8eb970870f072445675",
          },
        ];

        ethereum
          .request({
            method: "eth_sendTransaction",
            params: params,
          })
          .then((result) => {
            console.log("Success");
            // The result varies by by RPC method.
            // For example, this method will return a transaction hash hexadecimal string on success.
          })
          .catch((error) => {
            console.log("Error", error);

            // If the request fails, the Promise will reject with an error.
          });
      }

      function _findGetParameter(parameterName) {
        var result = null;
        var tmp = [];
        location.search
          .substr(1)
          .split("&")
          .forEach(function (item) {
            tmp = item.split("=");
            if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
          });
        return result;
      }
    </script>
  </body>
</html>
